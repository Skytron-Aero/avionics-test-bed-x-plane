<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Health Dashboard - Aviation Weather API</title>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(255, 255, 255, 0.03);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.4);
            --border-color: rgba(255, 255, 255, 0.08);
            --accent: #6366f1;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-top: 48px;
        }

        /* Top Navigation Bar */
        .top-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 9999;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .nav-brand svg {
            width: 24px;
            height: 24px;
            color: var(--accent);
        }

        .nav-links {
            display: flex;
            gap: 4px;
        }

        .nav-link {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .nav-link.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent);
        }

        .nav-link svg {
            width: 16px;
            height: 16px;
        }

        .content {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 24px;
        }

        .page-header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .page-header p {
            color: var(--text-tertiary);
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 16px;
        }

        .refresh-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            opacity: 0.9;
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .last-updated {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(20px);
        }

        .card.full-width {
            grid-column: 1 / -1;
        }

        .card-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-tertiary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title svg {
            width: 16px;
            height: 16px;
            color: var(--accent);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-value.success { color: var(--success); }
        .stat-value.warning { color: var(--warning); }
        .stat-value.danger { color: var(--danger); }

        .stat-label {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .service-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .service-status:last-child {
            margin-bottom: 0;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-dot.operational { background: var(--success); box-shadow: 0 0 12px var(--success); }
        .status-dot.degraded { background: var(--warning); box-shadow: 0 0 12px var(--warning); }
        .status-dot.offline { background: var(--danger); box-shadow: 0 0 12px var(--danger); }

        .service-info {
            flex: 1;
        }

        .service-name {
            font-weight: 600;
            font-size: 14px;
        }

        .service-detail {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        .service-response {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .data-source {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.01);
        }

        .data-source:last-child {
            margin-bottom: 0;
        }

        .data-source-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .data-source-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .data-source-badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .data-source-badge.official {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .data-source-badge.third-party {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent);
        }

        .data-source-url {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            margin: 12px 0;
            word-break: break-all;
        }

        .data-source-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .data-fields {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .data-field {
            font-size: 11px;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
            color: var(--text-tertiary);
            border: none;
            cursor: default;
            user-select: none;
        }

        .data-field.primary {
            background: rgba(99, 102, 241, 0.15);
            color: rgba(99, 102, 241, 0.9);
            font-weight: 500;
        }

        .endpoint-table {
            width: 100%;
            border-collapse: collapse;
        }

        .endpoint-table th,
        .endpoint-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .endpoint-table th {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
            background: rgba(255, 255, 255, 0.02);
        }

        .endpoint-table td {
            font-size: 13px;
        }

        .endpoint-table tr:last-child td {
            border-bottom: none;
        }

        .endpoint-name {
            font-weight: 600;
            color: var(--accent);
        }

        .success-rate {
            font-weight: 600;
        }

        .success-rate.good { color: var(--success); }
        .success-rate.warning { color: var(--warning); }
        .success-rate.bad { color: var(--danger); }

        .uptime-display {
            font-size: 48px;
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
            font-family: 'SF Mono', monospace;
        }

        .uptime-label {
            text-align: center;
            font-size: 14px;
            color: var(--text-tertiary);
        }

        .timestamp {
            font-family: 'SF Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--text-tertiary);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title svg {
            width: 20px;
            height: 20px;
            color: var(--accent);
        }

        .usage-list {
            list-style: none;
            padding: 0;
        }

        .usage-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .usage-list li:last-child {
            border-bottom: none;
        }

        .usage-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-navbar">
        <div class="nav-brand">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            Aviation Weather API
        </div>
        <div class="nav-links">
            <a href="/" class="nav-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                Weather Dashboard
            </a>
            <a href="/health-dashboard" class="nav-link active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                </svg>
                Data Health
            </a>
            <a href="/compliance-dashboard" class="nav-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11l3 3L22 4"/>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
                Compliance
            </a>
        </div>
    </nav>

    <div class="content">
        <div class="page-header">
            <h1>Data Health Dashboard</h1>
            <p>Monitor data sources, API health, and service status for the Aviation Weather system.</p>
            <div class="header-actions">
                <button class="refresh-btn" onclick="loadHealthData()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                    Refresh
                </button>
                <span class="last-updated" id="lastUpdated">Loading...</span>
            </div>
        </div>

        <!-- System Status Grid -->
        <div class="grid grid-2">
            <!-- Uptime Card -->
            <div class="card">
                <div class="card-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    System Uptime
                </div>
                <div class="uptime-display" id="uptime">--:--:--</div>
                <div class="uptime-label">Since <span id="startTime">--</span></div>
            </div>

            <!-- External Services Card -->
            <div class="card">
                <div class="card-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                    External Service Status
                </div>
                <div id="servicesContainer">
                    <div class="no-data loading">Checking services...</div>
                </div>
            </div>
        </div>

        <!-- API Endpoint Statistics -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                    <line x1="12" y1="22.08" x2="12" y2="12"/>
                </svg>
                API Endpoint Statistics
            </div>
            <div id="endpointStats">
                <div class="no-data loading">Loading endpoint data...</div>
            </div>
        </div>

        <!-- Data Sources Section -->
        <div class="section-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <ellipse cx="12" cy="5" rx="9" ry="3"/>
                <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
            </svg>
            Data Sources & Ground Truth
        </div>

        <div class="card full-width" style="margin-bottom: 24px;">
            <!-- FAA Aviation Weather -->
            <div class="data-source">
                <div class="data-source-header">
                    <div>
                        <div class="data-source-title">FAA Aviation Weather Center</div>
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">Official U.S. Government Source</div>
                    </div>
                    <span class="data-source-badge official">Official</span>
                </div>
                <div class="data-source-url">https://aviationweather.gov/api/data/</div>
                <div class="data-source-description">
                    The FAA Aviation Weather Center is the authoritative source for aviation weather data in the United States.
                    This data feeds directly from NWS (National Weather Service) and FAA systems, providing real-time METAR
                    observations and TAF forecasts for all US airports and many international stations.
                </div>
                <div style="margin-bottom: 12px; font-size: 12px; font-weight: 600; color: var(--text-tertiary);">DATA USED IN THIS APP:</div>
                <div class="data-fields">
                    <span class="data-field primary">METAR (Current Conditions)</span>
                    <span class="data-field primary">TAF (Terminal Forecast)</span>
                    <span class="data-field">Temperature</span>
                    <span class="data-field">Dewpoint</span>
                    <span class="data-field">Wind Speed/Direction</span>
                    <span class="data-field">Visibility</span>
                    <span class="data-field">Altimeter Setting</span>
                    <span class="data-field">Cloud Layers/Ceiling</span>
                    <span class="data-field">Flight Rules (VFR/IFR)</span>
                    <span class="data-field">Raw METAR/TAF Text</span>
                </div>
                <ul class="usage-list" style="margin-top: 16px;">
                    <li><span class="usage-icon"></span>METAR Card - Current weather observations</li>
                    <li><span class="usage-icon"></span>TAF Card - Terminal Aerodrome Forecast</li>
                    <li><span class="usage-icon"></span>VFR Minimums Check - Visibility & ceiling validation</li>
                    <li><span class="usage-icon"></span>Flight Rules Badge - VFR/MVFR/IFR/LIFR status</li>
                    <li><span class="usage-icon"></span>Hero Stats - Temperature, wind display</li>
                </ul>
            </div>

            <!-- Open-Meteo -->
            <div class="data-source">
                <div class="data-source-header">
                    <div>
                        <div class="data-source-title">Open-Meteo Weather API</div>
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">Open Source Weather Forecast</div>
                    </div>
                    <span class="data-source-badge third-party">Third Party</span>
                </div>
                <div class="data-source-url">https://api.open-meteo.com/v1/forecast</div>
                <div class="data-source-description">
                    Open-Meteo provides free weather forecast data aggregated from national weather services including
                    NOAA GFS, DWD ICON, and ECMWF. It offers hourly forecasts with high temporal resolution,
                    making it ideal for aviation planning beyond the TAF timeframe.
                </div>
                <div style="margin-bottom: 12px; font-size: 12px; font-weight: 600; color: var(--text-tertiary);">DATA USED IN THIS APP:</div>
                <div class="data-fields">
                    <span class="data-field primary">Hourly Forecast</span>
                    <span class="data-field">Temperature (2m)</span>
                    <span class="data-field">Wind Speed (10m)</span>
                    <span class="data-field">Wind Direction</span>
                    <span class="data-field">Cloud Cover %</span>
                    <span class="data-field">Pressure (MSL)</span>
                    <span class="data-field">Precipitation</span>
                    <span class="data-field">Humidity</span>
                </div>
                <ul class="usage-list" style="margin-top: 16px;">
                    <li><span class="usage-icon"></span>Forecast Charts - Temperature, wind, clouds, pressure graphs</li>
                    <li><span class="usage-icon"></span>Journey Profile - Route weather interpolation</li>
                </ul>
            </div>

            <!-- OpenWeatherMap Tiles -->
            <div class="data-source">
                <div class="data-source-header">
                    <div>
                        <div class="data-source-title">OpenWeatherMap Tile Layers</div>
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">Weather Map Overlays</div>
                    </div>
                    <span class="data-source-badge third-party">Third Party</span>
                </div>
                <div class="data-source-url">https://tile.openweathermap.org/map/{layer}/{z}/{x}/{y}.png</div>
                <div class="data-source-description">
                    OpenWeatherMap provides rasterized weather map tiles for visualization. These are rendered overlays
                    showing precipitation radar, cloud coverage, temperature gradients, wind patterns, and pressure systems
                    on the interactive Leaflet map.
                </div>
                <div style="margin-bottom: 12px; font-size: 12px; font-weight: 600; color: var(--text-tertiary);">DATA USED IN THIS APP:</div>
                <div class="data-fields">
                    <span class="data-field primary">Map Weather Overlays</span>
                    <span class="data-field">Precipitation Radar</span>
                    <span class="data-field">Cloud Cover</span>
                    <span class="data-field">Temperature</span>
                    <span class="data-field">Wind Speed</span>
                    <span class="data-field">Pressure</span>
                </div>
                <ul class="usage-list" style="margin-top: 16px;">
                    <li><span class="usage-icon"></span>Weather Map - Interactive overlay buttons</li>
                </ul>
            </div>

            <!-- FAA Regulations -->
            <div class="data-source">
                <div class="data-source-header">
                    <div>
                        <div class="data-source-title">FAA Regulations (14 CFR)</div>
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">Coded Reference Data</div>
                    </div>
                    <span class="data-source-badge official">Official</span>
                </div>
                <div class="data-source-url">14 CFR Part 91.155, 91.151, 91.167, 91.135</div>
                <div class="data-source-description">
                    VFR weather minimums, cloud clearance requirements, and fuel reserve regulations are coded into this
                    application based on the Federal Aviation Regulations. These are static reference values used to
                    validate current conditions against regulatory requirements.
                </div>
                <div style="margin-bottom: 12px; font-size: 12px; font-weight: 600; color: var(--text-tertiary);">REGULATIONS IMPLEMENTED:</div>
                <div class="data-fields">
                    <span class="data-field primary">14 CFR 91.155</span>
                    <span class="data-field">VFR Visibility Minimums</span>
                    <span class="data-field">Cloud Clearance by Airspace</span>
                    <span class="data-field">14 CFR 91.151 (VFR Fuel)</span>
                    <span class="data-field">14 CFR 91.167 (IFR Fuel)</span>
                    <span class="data-field">14 CFR 91.135 (Class A)</span>
                </div>
                <ul class="usage-list" style="margin-top: 16px;">
                    <li><span class="usage-icon"></span>VFR Minimums Check - Validates conditions against airspace requirements</li>
                    <li><span class="usage-icon"></span>Fuel Requirements Check - 30-min VFR / 45-min IFR reserve validation</li>
                </ul>
            </div>

            <!-- CartoDB Base Map -->
            <div class="data-source">
                <div class="data-source-header">
                    <div>
                        <div class="data-source-title">CartoDB Dark Matter</div>
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">Base Map Tiles</div>
                    </div>
                    <span class="data-source-badge third-party">Third Party</span>
                </div>
                <div class="data-source-url">https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png</div>
                <div class="data-source-description">
                    CartoDB provides the dark-themed base map tiles used in the weather map component. This gives a
                    clean, aviation-friendly dark background that makes weather overlays more visible.
                </div>
                <div style="margin-bottom: 12px; font-size: 12px; font-weight: 600; color: var(--text-tertiary);">DATA USED IN THIS APP:</div>
                <div class="data-fields">
                    <span class="data-field primary">Base Map Tiles</span>
                    <span class="data-field">Geographic Features</span>
                    <span class="data-field">Labels & Boundaries</span>
                </div>
            </div>
        </div>

        <!-- Data Flow Diagram -->
        <div class="card">
            <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
                Data Freshness & Update Frequency
            </div>
            <table class="endpoint-table">
                <thead>
                    <tr>
                        <th>Data Type</th>
                        <th>Source</th>
                        <th>Update Frequency</th>
                        <th>Caching</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="endpoint-name">METAR</span></td>
                        <td>FAA Aviation Weather</td>
                        <td>Hourly (typically :55 past the hour)</td>
                        <td>No cache - Live fetch</td>
                    </tr>
                    <tr>
                        <td><span class="endpoint-name">TAF</span></td>
                        <td>FAA Aviation Weather</td>
                        <td>Every 6 hours (00, 06, 12, 18 UTC)</td>
                        <td>No cache - Live fetch</td>
                    </tr>
                    <tr>
                        <td><span class="endpoint-name">Hourly Forecast</span></td>
                        <td>Open-Meteo</td>
                        <td>Hourly model updates</td>
                        <td>No cache - Live fetch</td>
                    </tr>
                    <tr>
                        <td><span class="endpoint-name">Weather Map Tiles</span></td>
                        <td>OpenWeatherMap</td>
                        <td>~10-15 minutes</td>
                        <td>Browser cached</td>
                    </tr>
                    <tr>
                        <td><span class="endpoint-name">FAA Regulations</span></td>
                        <td>Coded Reference</td>
                        <td>Static (code updates)</td>
                        <td>Built-in</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let autoRefreshInterval;

        async function loadHealthData() {
            const refreshBtn = document.querySelector('.refresh-btn');
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = `
                <svg class="loading" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
                Refreshing...
            `;

            try {
                const res = await fetch('/api/data-health');
                const data = await res.json();

                // Update last updated
                document.getElementById('lastUpdated').textContent =
                    `Last updated: ${new Date(data.current_time).toLocaleString()}`;

                // Update uptime
                document.getElementById('uptime').textContent = data.uptime_formatted;
                document.getElementById('startTime').textContent =
                    new Date(data.start_time).toLocaleString();

                // Update external services
                const servicesHtml = Object.entries(data.external_services).map(([name, info]) => `
                    <div class="service-status">
                        <div class="status-dot ${info.status}"></div>
                        <div class="service-info">
                            <div class="service-name">${formatServiceName(name)}</div>
                            <div class="service-detail">${info.status.toUpperCase()}</div>
                        </div>
                        <div class="service-response">
                            ${info.response_time_ms ? `${info.response_time_ms.toFixed(0)}ms` : info.error || '--'}
                        </div>
                    </div>
                `).join('');
                document.getElementById('servicesContainer').innerHTML = servicesHtml || '<div class="no-data">No services data</div>';

                // Update endpoint statistics
                const endpoints = data.endpoints;
                if (Object.keys(endpoints).length > 0) {
                    const tableHtml = `
                        <table class="endpoint-table">
                            <thead>
                                <tr>
                                    <th>Endpoint</th>
                                    <th>Total Calls</th>
                                    <th>Success Rate</th>
                                    <th>Avg Response</th>
                                    <th>Last Success</th>
                                    <th>Last Error</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(endpoints).map(([name, stats]) => {
                                    const successRate = stats.total_calls > 0
                                        ? ((stats.successful_calls / stats.total_calls) * 100).toFixed(1)
                                        : 0;
                                    const rateClass = successRate >= 95 ? 'good' : successRate >= 80 ? 'warning' : 'bad';
                                    return `
                                        <tr>
                                            <td><span class="endpoint-name">${name}</span></td>
                                            <td>${stats.total_calls}</td>
                                            <td><span class="success-rate ${rateClass}">${successRate}%</span></td>
                                            <td>${stats.avg_response_time_ms.toFixed(0)}ms</td>
                                            <td class="timestamp">${stats.last_success ? formatTime(stats.last_success) : '--'}</td>
                                            <td class="timestamp">${stats.last_error ? formatTime(stats.last_error) : '--'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById('endpointStats').innerHTML = tableHtml;
                } else {
                    document.getElementById('endpointStats').innerHTML =
                        '<div class="no-data">No API calls recorded yet. Use the main Weather Dashboard to generate data.</div>';
                }

            } catch (error) {
                console.error('Failed to load health data:', error);
                document.getElementById('lastUpdated').textContent = 'Failed to load data';
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                    Refresh
                `;
            }
        }

        function formatServiceName(name) {
            return name.split('_').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
            return date.toLocaleDateString();
        }

        // Load on page load
        loadHealthData();

        // Auto-refresh every 30 seconds
        autoRefreshInterval = setInterval(loadHealthData, 30000);
    </script>
</body>
</html>
